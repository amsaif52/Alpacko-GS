<!DOCTYPE html>
<html>
  <head>
    <?!= HtmlService.createHtmlOutputFromFile('Style').getContent(); ?>
  </head>
  <body>
    <div id="overlay" style="display: none">
      <div id="spinner"></div>
    </div>
    <div id="confirmation" style="display: none">
      <div id="updated">UPDATED!!!</div>
    </div>
    <div id="tab-navigation">
      <button id="btnTab1" class="tab-button" onclick="showTab('tab1')">
        Scan
      </button>
      <button id="btnTab2" class="tab-button" onclick="showTab('tab2')">
        Sale PO Order
      </button>
      <button id="btnTab3" class="tab-button" onclick="showTab('tab3')">
        Inventory
      </button>
      <button id="btnTab4" class="tab-button" onclick="showTab('tab4')">
        Sheet Order
      </button>
    </div>
    <div id="tab1" class="tab-content">
      <div id="qr-reader" style="width: 700px"></div>
      <div id="qr-reader-results"></div>
      <div id="result"></div>
      <div id="result1"></div>
    </div>
    <div id="tab2" class="tab-content" style="display: none">
      <div id="order-results"></div>
      <div id="order-print"></div>
    </div>
    <div id="tab3" class="tab-content" style="display: none">
      <div id="inventory-results"></div>
    </div>
    <div id="tab4" class="tab-content" style="display: none">
      <div id="sale-po-results"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
      let lastResult,
        countResults = 0;
      function onScanSuccess(decodedText, decodedResult) {
        if (decodedText !== lastResult) {
          ++countResults;
          lastResult = decodedText;
          if (decodedText) {
            if (
              typeof google !== "undefined" &&
              google.script &&
              google.script.run
            ) {
              google.script.run
                .withSuccessHandler(function (data) {
                  onQRCodeFound(data);
                })
                .withFailureHandler(function (error) {
                  hideSpinner();
                  alert("Error in searchSheetForUrl: " + error.message);
                })
                .searchPrimarySheet(decodedText);
            } else {
              console.error("google.script.run is not defined.");
              hideSpinner();
              alert("Error: google.script.run is not defined.");
            }
          }
        }
      }

      function showSpinner() {
        document.getElementById("overlay").style.display = "flex";
      }

      function hideSpinner() {
        document.getElementById("overlay").style.display = "none";
      }

      function showUpdate(text) {
        document.getElementById("updated").innerHTML = text;
        document.getElementById("confirmation").style.display = "flex";
      }

      function hideUpdate() {
        document.getElementById("confirmation").style.display = "none";
      }

      function showTab(tabId) {
        // Hide all tab contents
        let tabs = document.getElementsByClassName("tab-content");
        for (var i = 0; i < tabs.length; i++) {
          tabs[i].style.display = "none";
        }
        document.getElementById(tabId).style.display = "flex";
        document.getElementById(tabId).style.width = "95%";

        // Update tab button styles
        // let tabButtons = document.getElementsByClassName("tab-button");
        // for (var i = 0; i < tabButtons.length; i++) {
        //   tabButtons[i].classList.remove("tab-button-active");
        // }
        // document
        //   .getElementById("btn" + tabId)
        //   .classList.add("tab-button-active");
      }

      function populateResults(data) {
        const { finalData } = data;

        const orderResultsContainer = document.getElementById("order-results");
        orderResultsContainer.innerHTML = "";
        finalData.forEach((order) => {
          const orderElement = document.createElement("div");
          orderElement.className = "order-item";
          let printElement = "<div id='printElement'>";

          const fields = [
            { label: "Vendor PO #", value: order["Vendor PO#"] },
            { label: "Vendor Name", value: order["Vendor Name"] },
            { label: "ETC/Wall", value: order["ETC/Wall"] },
            { label: "Length", value: order["Length"] },
            { label: "Breadth", value: order["Breadth"] },
            { label: "Width", value: order["Width"] },
            { label: "Flute", value: order["Flute"] },
            { label: "Expected Qty", value: order["Expected Qty"] },
            { label: "Arrival Date", value: order["Arrival Date"] },
          ];

          const printFields = [
            order["QR Code"],
            order["Customer"],
            order["Sheet Width"],
            order["Sheet Height"],
            order["ETC/Wall"],
          ];

          fields.forEach((field) => {
            const p = document.createElement("p");
            p.innerHTML = `<strong>${field.label}:</strong> ${field.value}`;
            orderElement.appendChild(p);
          });

          printFields.forEach((field, index) => {
            if (index === 0) {
              printElement += "<img src='" + field + "' style='width: 300px;'>";
            } else {
              printElement +=
                "<p><strong>" +
                fields[index].label +
                ":</strong> " +
                field +
                "</p>";
            }
          });

          printElement +=
            "<button onclick='printImageAndText()'>Print</button>";

          orderElement.appendChild(printElement);

          orderResultsContainer.innerHTML += orderElement;
        });
        hideSpinner();
      }

      function populateInventoryResults(data) {
        const { finalData } = data;
        const orderResultsContainer =
          document.getElementById("inventory-results");
        if (finalData.length === 0) {
          orderResultsContainer.innerHTML = "No Excess Inventory found.";
          hideSpinner();
          return;
        }
        orderResultsContainer.innerHTML = "";
        finalData.forEach((order) => {
          let orderElement = "<div class='inventory-item'>";

          const fields = [
            {
              label: "SUK#",
              value: order["SUK#"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "ECT/Wall",
              value: order["ECT/Wall"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "L (in)",
              value: order["L(in)"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "B (in)",
              value: order["B(in)"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "W (in)",
              value: order["W(in)"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Flute",
              value: order["Flute"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Sheet W",
              value: order["SheetW"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Sheet L",
              value: order["SheetL"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Customer",
              value: order["Customer"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Total Inventory",
              value: order["TotalInventory"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "QR Code",
              value: order["QRcode"],
              img: true,
              division: false,
              idivision: false,
            },
            {
              label: "Last Updated",
              value: order["LastUpdated"],
              img: false,
              division: true,
              idivision: false,
            },
          ];

          fields.forEach((field) => {
            const p = document.createElement("p");
            if (field.idivision) {
              orderElement += "<div>";
            }
            if (field.img) {
              orderElement += `<p><strong>${field.label}:</strong> <img src="${field.value}" alt="${field.label}" style="width: 100px;"></p>`;
            } else {
              orderElement += `<p><strong>${field.label}:</strong> ${field.value}</p>`;
            }
            if (field.division) {
              orderElement += "</div>";
            }
          });

          const orderElementNode = document.createElement("div");
          orderElementNode.innerHTML = orderElement;
          orderResultsContainer.appendChild(orderElementNode);
        });
        hideSpinner();
      }

      function populateSalesPOResults(data) {
        const { finalData } = data;
        const salePoContainer = document.getElementById("sale-po-results");
        if (finalData.length === 0) {
          salePoContainer.innerHTML = "No Sheet orders found.";
          hideSpinner();
          return;
        }
        salePoContainer.innerHTML = "";
        finalData.forEach((order, index) => {
          let salePoElement = "<div class='sale-po-item'>";
          let printElement = `<div id='printElement${index}' class='printElement'>`;

          const fields = [
            {
              label: "SUK#",
              value: order["SUK#"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "ECT/Wall",
              value: order["ECT/Wall"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "L (in)",
              value: order["L(in)"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "B (in)",
              value: order["B(in)"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "W (in)",
              value: order["W(in)"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Flute",
              value: order["Flute"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Sheet W",
              value: order["SheetW"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Sheet L",
              value: order["SheetL"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Vendor PO#",
              value: order["VendorPO#"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Vendor Name",
              value: order["VendorName"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Vendor sheet Arrival Date",
              value: order["VendorsheetArrivalDate"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "QR Code",
              value: order["QRcode"],
              img: true,
              division: false,
              idivision: true,
            },
            {
              label: "Last Updated",
              value: order["LastUpdated"],
              img: false,
              division: true,
              idivision: false,
            },
          ];

          const printFields = [
            order["QRcode"],
            order["Customer"],
            order["SheetW"],
            order["SheetL"],
            order["ECT/Wall"],
          ];

          window.printImageAndText = function (getId) {
            const printContents = document.getElementById(getId).innerHTML;
            const printWindow = window.open("", "_blank");
            printWindow.document.write(
              "<html><head><title>Print</title></head><body>" +
                printContents +
                "</body></html>"
            );
            printWindow.document.close();
            printWindow.print();
          };

          printFields.forEach((field, index) => {
            if (index === 0) {
              printElement += "<img src='" + field + "' style='width: 300px;'>";
            } else {
              printElement +=
                "<p><strong>" +
                fields[index].label +
                ":</strong> " +
                field +
                "</p>";
            }
          });

          fields.forEach((field) => {
            const p = document.createElement("p");
            if (field.idivision) {
              salePoElement += "<div>";
            }
            if (field.img) {
              salePoElement += `<p><strong>${field.label}:</strong> <img src="${field.value}" alt="${field.label}" style="width: 100px;"></p>`;
            } else {
              salePoElement += `<p><strong>${field.label}:</strong> ${field.value}</p>`;
            }
            if (field.division) {
              salePoElement += "</div>";
            }
          });

          salePoElement += `<button onclick='printImageAndText("printElement${index}")'>Print</button>`;

          salePoElement += printElement;
          const salePoNode = document.createElement("div");
          salePoNode.innerHTML = salePoElement;
          salePoContainer.appendChild(salePoNode);
        });
        hideSpinner();
      }

      function populateOrderResults(data) {
        const { finalData } = data;
        const salePoContainer = document.getElementById("order-results");
        if (finalData.length === 0) {
          salePoContainer.innerHTML = "No Sale PO orders found.";
          hideSpinner();
          return;
        }
        salePoContainer.innerHTML = "";
        finalData.forEach((order) => {
          let salePoElement = "<div class='order-item'>";

          const fields = [
            {
              label: "SUK#",
              value: order["SUK#"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "ECT/Wall",
              value: order["ECT/Wall"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "L (in)",
              value: order["L(in)"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "B (in)",
              value: order["B(in)"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "W (in)",
              value: order["W(in)"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Flute",
              value: order["Flute"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Print N/Y",
              value: order["PrintN/Y"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Expected Qty",
              value: order["ExpectedQty"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Sheet W",
              value: order["SheetW"],
              img: false,
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Sheet L",
              value: order["SheetL"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Vendor PO#",
              value: order["VendorPO#"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Vendor Name",
              value: order["VendorName"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Vendor sheet Arrival Date",
              value: order["VendorsheetArrivalDate"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Customer",
              value: order["Customer"],
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Customer PO",
              value: order["CustomerPO"],
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Customer PO Qty",
              value: order["CustomerPOQty"],
              img: false,
              division: true,
              idivision: false,
            },
            {
              label: "Print",
              value: order["Print"],
              img: false,
              division: false,
              idivision: true,
              type: "bool",
            },
            {
              label: "Cut",
              value: order["Cut"],
              img: false,
              division: false,
              idivision: false,
              type: "bool",
            },
            {
              label: "Glue",
              value: order["Glue"],
              img: false,
              division: true,
              idivision: false,
              type: "bool",
            },
            ...(order["PalletStatus"]
              ? [
                  {
                    label: "Total Number of Boxes",
                    value: order["TotalNumberofBoxes"],
                    img: false,
                    division: false,
                    idivision: true,
                  },
                ]
              : []),
            ...(order["PalletStatus"]
              ? [
                  {
                    label: "Skid #",
                    value: order["Skid#"],
                    img: false,
                    division: true,
                    idivision: false,
                  },
                ]
              : []),
            {
              label: "Delivery Date",
              value: order["DeliveryDate"],
              img: false,
              img: false,
              division: false,
              idivision: true,
            },
            {
              label: "Total Inventory",
              value: order["TotalInventory"],
              img: false,
              img: false,
              division: false,
              idivision: false,
            },
            {
              label: "Last Updated",
              value: order["LastUpdated"],
              img: false,
              division: true,
              idivision: false,
            },
            { button: true },
          ];
          window.shippedTransaction = function (suk) {
            showSpinner();
            google.script.run
              .withSuccessHandler(function (updatedRowData) {
                hideSpinner();
                showUpdate("Shipped");
                setTimeout(function () {
                  hideUpdate();
                  document.getElementById("result").innerText = "";
                  document.getElementById("result1").innerText = "";
                  lastResult = null;
                  html5QrcodeScanner
                    .clear()
                    .then(() => {
                      console.log("QR Code scanner reset successfully.");
                      html5QrcodeScanner.render(onScanSuccess);
                    })
                    .catch((error) => {
                      console.error("Failed to reset QR Code scanner:", error);
                    });
                }, 1000);
              })
              .withFailureHandler(function (error) {
                alert("Error in searchSheetForUrl:", error);
                hideSpinner();
              })
              .shippedTransaction(suk);
          };
          window.updateOrderTransaction = function (suk) {
            google.script.run
              .withSuccessHandler(function (data) {
                onQRCodeFound(data);
                showTab("tab1");
              })
              .withFailureHandler(function (error) {
                hideSpinner();
                alert("Error in searchSheetForUrl: " + error.message);
              })
              .searchPrimarySheet(`${suk}`);
          };

          fields.forEach((field) => {
            if (field.button) {
              salePoElement += `<button ${
                order["PalletStatus"].toString().toLowerCase() !== "true"
                  ? "disabled"
                  : ""
              } onclick='shippedTransaction("${
                order["SUK#"]
              }")'>Shipped</button><button onclick='updateOrderTransaction("${
                order["SUK#"]
              }")'>Go To Order</button>`;
            }
            if (field.idivision) {
              salePoElement += "<div>";
            }
            if (field.img) {
              salePoElement += `<p><strong>${field.label}:</strong> <img src="${field.value}" alt="${field.label}" style="width: 100px;"></p>`;
            } else if (!field.button) {
              if (field.type === "bool") {
                salePoElement += `<p><strong>${field.label}:</strong> ${
                  field.value || false
                }</p>`;
              } else {
                salePoElement += `<p><strong>${field.label}:</strong> ${
                  field.value || ""
                }</p>`;
              }
            }
            if (field.division) {
              salePoElement += "</div>";
            }
          });

          const salePoNode = document.createElement("div");
          salePoNode.innerHTML = salePoElement;
          salePoContainer.appendChild(salePoNode);
        });
        hideSpinner();
      }

      document.addEventListener("DOMContentLoaded", function () {
        var btnTab3 = document.getElementById("btnTab3");
        if (btnTab3) {
          btnTab3.addEventListener("click", function () {
            showSpinner();
            google.script.run
              .withSuccessHandler(populateInventoryResults)
              .withFailureHandler(function () {
                showSpinner();
              })
              .getFilteredOrders("inventory");
          });
        } else {
          console.log("Element with ID btnTab3 not found.");
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        var btnTab3 = document.getElementById("btnTab4");
        if (btnTab3) {
          btnTab3.addEventListener("click", function () {
            showSpinner();
            google.script.run
              .withSuccessHandler(populateSalesPOResults)
              .withFailureHandler(function () {
                showSpinner();
              })
              .getFilteredOrders("orders");
          });
        } else {
          console.log("Element with ID btnTab4 not found.");
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        var btnTab2 = document.getElementById("btnTab2");
        if (btnTab2) {
          btnTab2.addEventListener("click", function () {
            showSpinner();
            google.script.run
              .withSuccessHandler(populateOrderResults)
              .withFailureHandler(function () {
                showSpinner();
              })
              .getFilteredOrders("salePO");
          });
        } else {
          console.log("Element with ID btnTab2 not found.");
        }
      });

      function onQRCodeFound(rowData) {
        hideSpinner();
        if (rowData) {
          console.log(rowData);
          displayRowData(rowData);
        } else {
          document.getElementById("result").innerHTML =
            "No match found in the sheet.";
        }
      }

      const html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", {
        fps: 10,
        qrbox: 450,
      });
      html5QrcodeScanner.render(onScanSuccess);

      function displayRowData(rowData) {
        window.calculateResult = function () {
          showSpinner();
          setTimeout(function () {
            var numberInput = parseFloat(
              document.getElementById("numberInput").value
            );

            var result = value - numberInput;

            result = result < 0 ? 0 : result;

            if (!isNaN(result)) {
              document.getElementById("resultBox").value = result;
            } else {
              document.getElementById("resultBox").value = "Invalid input";
            }

            hideSpinner();
          }, 10);
        };

        window.handleCheckboxChange = function () {
          var checkbox = document.querySelectorAll("input.checkbox");
          console.log(checkbox);
          for (let i = 0; i < checkbox.length; i++) {
            if (checkbox[i].checked) {
              checkbox[i].setAttribute("checked", "checked");
            } else {
              checkbox[i].removeAttribute("checked");
            }
          }
        };

        window.updateDeliver = function () {
          showSpinner();
          if (
            document.getElementById("recInput").value <= 0 &&
            document.getElementById("etcInput").value <= 0
          ) {
            alert("Please enter both EC# Confirmation and Rec Qty");
            hideSpinner();
            return;
          }
          // if (
          //   document.getElementById("recInput").value.toString() ===
          //     rowData[24].toString() &&
          //   document.getElementById("etcInput").value.toString() ===
          //     rowData[22].toString()
          // ) {
          //   alert("Rec Qty or ECT# Confirmatiion are already updated");
          //   hideSpinner();
          //   return;
          // }
          let redBckg = [];
          if (
            document.getElementById("etcInput").value &&
            rowData[1] &&
            document.getElementById("etcInput").value.toString() !==
              rowData[1].toString().match(/\d+/)[0]
          ) {
            redBckg.push("etcConfirmation");
          }
          var calculatedValue = {
            recQty:
              document.getElementById("recInput").value.toString() ===
              rowData[24].toString()
                ? rowData[24]
                : document.getElementById("recInput").value || 0,
            etcConfirmation:
              document.getElementById("etcInput").value.toString() ===
              rowData[22].toString()
                ? rowData[22]
                : document.getElementById("etcInput").value || 0,
            sheetLocation:
              document.getElementById("boxLocationInput").value || 0,
            totalInventory:
              parseFloat(rowData[23] ? rowData[23] : 0, 0) +
              Math.abs(
                parseFloat(rowData[24] ? rowData[24] : 0) -
                  parseFloat(document.getElementById("recInput").value || 0, 0)
              ),
            expectedQty:
              parseFloat(rowData[7] ? rowData[7] : 0, 0) -
              parseFloat(document.getElementById("recInput").value || 0, 0),
          };
          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("Received!!!");
              setTimeout(function () {
                document.getElementById("recInput").innerText =
                  updatedRowData[2].recQty;
                document.getElementById("etcInput").innerText =
                  updatedRowData[2].etcConfirmation;
                document.getElementById("currInv").innerText =
                  updatedRowData[2].totalInventory;
                document.getElementById("expQty").innerText =
                  updatedRowData[2].expectedQty;
                hideUpdate();
              }, 1000);
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .updateShippedStatus(rowData, calculatedValue, redBckg);
        };

        window.updateDamage = function () {
          showSpinner();
          console.log(rowData, "****");
          var calculatedValue = {
            damageNumber: parseFloat(
              document.getElementById("damageInput").value ?? 0
            ),
            damageComments:
              document.getElementById("damageCommentsInput").value ?? "",
            processSheets:
              parseFloat(
                document.getElementById("processSheetsInput").value ?? 0,
                0
              ) - parseFloat(document.getElementById("damageInput").value),
          };
          console.log(calculatedValue, "****");
          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("DAMAGE UPDATED!!!");
              setTimeout(function () {
                document.getElementById("damageInput").innerText =
                  updatedRowData[2].damageNumber;
                document.getElementById("damageCommentsInput").innerText =
                  updatedRowData[2].damageComments;
                document.getElementById("processSheetsInput").value =
                  updatedRowData[2].processSheets;
                hideUpdate();
              }, 1000);
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .updateDamage(rowData, calculatedValue);
        };

        window.submitInvBySheets = function () {
          showSpinner();
          if (
            parseFloat(document.getElementById("currInv").innerText || 0) <
            parseFloat(document.getElementById("processSheetsInput").value || 0)
          ) {
            alert("Cannot process more sheets than the total inventory");
            hideSpinner();
            return;
          }
          var calculatedValue = {
            processSheets: parseFloat(
              document.getElementById("processSheetsInput").value || 0,
              0
            ),
            totalInventory:
              parseFloat(document.getElementById("currInv").innerText || 0) -
              parseFloat(
                document.getElementById("processSheetsInput").value || 0,
                0
              ),
          };
          console.log(calculatedValue, "****");
          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("INVENTORY UPDATED!!!");
              console.log(updatedRowData);
              if (updatedRowData.length) {
                setTimeout(function () {
                  document.getElementById("currInv").innerText =
                    updatedRowData[2].totalInventory;
                  document.getElementById("processSheetsInput").value =
                    updatedRowData[2].processSheets;
                  hideUpdate();
                }, 1000);
              } else {
                console.error("Updated data format is incorrect");
              }
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .updateInvBySheets(rowData, calculatedValue);
        };

        window.updateInvBySheets = function () {
          showSpinner();
          if (
            parseFloat(document.getElementById("currInv").innerText || 0) <
            parseFloat(document.getElementById("addSheetsInput").value)
          ) {
            alert("Cannot add more sheets than the total inventory");
            hideSpinner();
            return;
          }
          var calculatedValue = {
            processSheets:
              parseFloat(
                document.getElementById("processSheetsInput").value ?? 0,
                0
              ) +
              parseFloat(
                document.getElementById("addSheetsInput").value ?? 0,
                0
              ),
            totalInventory:
              parseFloat(document.getElementById("currInv").innerText || 0) -
              parseFloat(
                document.getElementById("addSheetsInput").value ?? 0,
                0
              ),
          };
          console.log(calculatedValue, "****");
          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("INVENTORY/PROCESS SHEETS UPDATED!!!");
              if (updatedRowData.length) {
                console.log(updatedRowData, "****");
                setTimeout(function () {
                  document.getElementById("currInv").innerText =
                    updatedRowData[2].totalInventory;
                  document.getElementById("processSheetsInput").value =
                    updatedRowData[2].processSheets;
                  document.getElementById("addSheetsInput").value = 0;
                  hideUpdate();
                }, 1000);
              } else {
                console.error("Updated data format is incorrect");
              }
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .updateInvBySheets(rowData, calculatedValue);
        };

        window.removeInvBySheets = function () {
          showSpinner();
          if (
            parseFloat(
              document.getElementById("processSheetsInput").value || 0
            ) < parseFloat(document.getElementById("addSheetsInput").value)
          ) {
            alert("Cannot remove more sheets than the process sheets");
            hideSpinner();
            return;
          }
          var calculatedValue = {
            processSheets:
              parseFloat(
                document.getElementById("processSheetsInput").value ?? 0,
                0
              ) -
              parseFloat(
                document.getElementById("addSheetsInput").value ?? 0,
                0
              ),
            totalInventory:
              parseFloat(document.getElementById("currInv").innerText || 0) +
              parseFloat(
                document.getElementById("addSheetsInput").value ?? 0,
                0
              ),
          };
          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("PROCESS SHEETS REMOVED!!!");
              if (updatedRowData.length) {
                setTimeout(function () {
                  document.getElementById("currInv").innerText =
                    updatedRowData[2].totalInventory;
                  document.getElementById("processSheetsInput").value =
                    updatedRowData[2].processSheets;
                  document.getElementById("addSheetsInput").value = 0;
                  hideUpdate();
                }, 1000);
              } else {
                console.error("Updated data format is incorrect");
              }
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .updateInvBySheets(rowData, calculatedValue);
        };

        window.updateStatus = function () {
          showSpinner();
          var calculatedValue = {
            printNumber:
              document.getElementById("printCheckInput").checked ?? false,
            cutNumber:
              document.getElementById("cutCheckInput").checked ?? false,
            glueNumber:
              document.getElementById("glueCheckInput").checked ?? false,
          };
          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("STATUS UPDATED!!!");
              setTimeout(function () {
                document.getElementById("printCheckInput").checked =
                  updatedRowData[2].printNumber;
                document.getElementById("cutCheckInput").checked =
                  updatedRowData[2].cutNumber;
                document.getElementById("glueCheckInput").checked =
                  updatedRowData[2].glueNumber;
                hideUpdate();
              }, 1000);
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .updateStatus(rowData, calculatedValue);
        };

        window.updateInventory = function () {
          showSpinner();
          var calculatedValue =
            document.getElementById("updateInventoryInput").value ?? 0;
          if (!calculatedValue) {
            alert("Please enter a value to update inventory");
            hideSpinner();
            return;
          }
          if (rowData[18].toString() === calculatedValue.toString()) {
            alert("Inventory is already updated");
            hideSpinner();
            return;
          }
          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("INVENTORY UPDATED!!!");
              console.log(updatedRowData, "***");
              if (updatedRowData.length) {
                setTimeout(function () {
                  document.getElementById("currInv").innerText =
                    updatedRowData[1];
                  document.getElementById("recInput").value = updatedRowData[0];
                  document.getElementById("updateInventoryInput").value = 0;
                  hideUpdate();
                }, 1000);
              } else {
                console.error("Updated data format is incorrect");
              }
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .updateInv(
              rowData,
              "totalInventory",
              "recQty",
              parseFloat(calculatedValue)
            );
        };

        window.submitPallet = function () {
          showSpinner();
          var calculatedValue = {
            skidNumber: document.getElementById("skidInput").value ?? 0,
            totalNumberBoxes:
              document.getElementById("totalNumberBoxesInput").value ?? 0
          };
          if (
            !(calculatedValue.totalNumberBoxes && calculatedValue.skidNumber)
          ) {
            alert(
              "Both total number of boxes and skid number should be filled!"
            );
            hideSpinner();
            return;
          }

          google.script.run
            .withSuccessHandler(function (updatedRowData) {
              hideSpinner();
              showUpdate("Palletized!!!");
              if (updatedRowData.length) {
                setTimeout(function () {
                  hideUpdate();
                  document.getElementById("skidInput").value =
                    calculatedValue.skidNumber;
                  document.getElementById("totalNumberBoxesInput").value =
                    calculatedValue.totalNumberBoxes;
                }, 1000);
              } else {
                console.error("Updated data format is incorrect");
              }
            })
            .withFailureHandler(function (error) {
              alert("Error in searchSheetForUrl:", error);
              hideSpinner();
            })
            .palletTransaction(rowData, calculatedValue);
        };

        var value = rowData[1];
        var displayText =
          '<div class="info-table">' +
          '<div class="info-row"><div class="info-label">Vendor PO #:</div><div>' +
          rowData[15] +
          '</div><div class="info-label">Vendor Name:</div><div>' +
          rowData[16] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Sku Id:</div><div>' +
          rowData[0] +
          '</div><div class="info-label">Etc Num:</div><div>' +
          rowData[1] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Length:</div><div>' +
          rowData[2] +
          '</div><div class="info-label">Breadth:</div><div>' +
          rowData[3] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Width:</div><div>' +
          rowData[4] +
          '</div><div class="info-label">Flute:</div><div>' +
          rowData[5] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Print:</div><div>' +
          rowData[6] +
          '</div><div class="info-label">Expected Qty:</div><div id="expQty">' +
          rowData[7] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Arrival Date:</div><div>' +
          rowData[17] +
          '</div><div class="info-label">Customer:</div><div>' +
          rowData[18] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Sheet Width:</div><div>' +
          rowData[9] +
          '</div><div class="info-label">Sheet Length:</div><div>' +
          rowData[10] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Customer PO:</div><div>' +
          rowData[19] +
          '</div><div class="info-label">Customer PO Qty:</div><div>' +
          rowData[20] +
          "</div></div>" +
          '<div class="info-row"><div class="info-label">Delivery Date:</div><div>' +
          rowData[21] +
          '</div><div class="info-label">Updated At:</div><div>' +
          rowData[38] +
          "</div></div>" +
          "</div>";

        document.getElementById("result").innerHTML = displayText;
        var displayText1 = `<div>Current Inventory: <br><span id="currInv">${rowData[23]}</span></div>`;
        displayText1 += `<div>ECT# Confirmation: <br><input type="number" inputmode="numeric" step="1" value="${rowData[22]}" id="etcInput" ></div>`;
        displayText1 += `<div>Rec Qty: <br><input type="number" value="${rowData[24]}" inputmode="numeric" step="1" id="recInput" min="0"></div>`;
        displayText1 += `<div>Box Location: <br><input type="text" value="${rowData[33]}" id="boxLocationInput"></div>`;
        displayText1 += `<button onclick="updateDeliver()" class="inputted">Received</button>`;
        displayText1 += `<div class="divider"></div>`;
        displayText1 += `<div>Process Sheets: <br><input type="number" value="${rowData[25]}" inputmode="numeric" step="1" id="processSheetsInput" min="0"></div>`;
        displayText1 += `<div>Add Sheets: <br><div class="addSheets"><input type="number" inputmode="numeric" step="1" id="addSheetsInput" min="0"><div><button onclick="updateInvBySheets()" >Add</button><button onclick="removeInvBySheets()" >Remove</button></div></div></div>`;
        displayText1 += `<button onclick="submitInvBySheets()" class="inputted">Submit</button>`;
        displayText1 += `<div class="divider"></div>`;
        displayText1 += `<div class="checkboxStatus"><div>Print: <input type="checkbox" class="checkbox" id="printCheckInput" ${
          rowData[26] ? "checked" : ""
        }></div>`;
        displayText1 += `<div>Cut: <input type="checkbox" class="checkbox" id="cutCheckInput" ${
          rowData[27] ? "checked" : ""
        }></div>`;
        displayText1 += `<div>Glue: <input type="checkbox" class="checkbox" id="glueCheckInput" ${
          rowData[28] ? "checked" : ""
        }></div></div>`;
        displayText1 += `<button onclick="updateStatus()" class="inputted">Submit</button>`;
        displayText1 += `<div class="divider"></div>`;
        displayText1 += `<div>Damage: <br><input type="number" value="${rowData[29]}" inputmode="numeric" step="1" id="damageInput" min="0"></div>`;
        displayText1 += `<div>Damage Comments: <br><textarea id="damageCommentsInput">${rowData[30]}</textarea></div>`;
        displayText1 += `<button onclick="updateDamage()" class="inputted">Submit</button>`;
        displayText1 += `<div class="divider"></div>`;
        displayText1 += `<div>Total Number of Boxes: <br><input type="number" value="${rowData[31]}" inputmode="numeric" step="1" id="totalNumberBoxesInput" min="0"></div>`;
        displayText1 += `<div>Skid#: <br><input type="number" value="${rowData[32]}" inputmode="numeric" step="1" id="skidInput" min="0"></div>`;
        displayText1 += `<button onclick="submitPallet()" class="inputted">Palletized</button>`;
        displayText1 += `</div>`;

        document.getElementById("result1").innerHTML = displayText1;
      }
    </script>
  </body>
</html>
